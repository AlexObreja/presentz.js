/*
Presentz - A web library to show synchronized video + slides presentations

Copyright (C) 2012 Federico Fissore

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/// Generated by CoffeeScript 1.3.3
(function(){var e,t,n,r,i,s,o,u,a,f,l=function(e,t){return function(){return e.apply(t,arguments)}},c=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};u=function(){function e(e,t,n,r){this.playState=e,this.pauseState=t,this.finishState=n,this.presentz=r,this.isInPauseState=!1}return e.prototype.handleEvent=function(e){e===this.playState?this.presentz.startTimeChecker():(e===this.pauseState||e===this.finishState)&&this.presentz.stopTimeChecker(),e===this.finishState&&this.presentz.currentChapterIndex<this.presentz.howManyChapters-1&&this.presentz.changeChapter(this.presentz.currentChapterIndex+1,0,!0),this.isInPauseState=e===this.pauseState},e.prototype.isPaused=function(){return this.isInPauseState},e}(),t=function(){function e(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.video=new u("play","pause","ended",this.presentz),this.elementId=this.presentz.newElementName()}return e.prototype.changeVideo=function(e,t){var n,r,i=this;this.wouldPlay=t,$(this.videoContainer).empty(),r='<video id="'+this.elementId+'" controls preload="none" src="'+e.url+'" width="100%" height="100%"></video>',$(this.videoContainer).append(r),n={timerRate:500,success:function(e){i.onPlayerLoaded(e)}},new MediaElementPlayer("#"+this.elementId,n)},e.prototype.onPlayerLoaded=function(e){var t,n=this;this.player=e,t=function(e){n.video.handleEvent(e.type)},e.addEventListener("play",t,!1),e.addEventListener("pause",t,!1),e.addEventListener("ended",t,!1),this.player.load(),this.wouldPlay&&(this.presentz.intervalSet||this.presentz.startTimeChecker(),this.player.play())},e.prototype.currentTime=function(){return this.player.currentTime},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),this.player&&this.player.currentTime&&(this.player.setCurrentTime(e),t&&this.player.play(),!0),!1},e.prototype.play=function(){return this.player.play()},e.prototype.pause=function(){return this.player.pause()},e.prototype.isPaused=function(){return this.video.isPaused()},e}(),a=function(){function t(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.receiveVideoInfo=l(this.receiveVideoInfo,this),this.video=new u("play","pause","finish",this.presentz),this.wouldPlay=!1,this.currentTimeInSeconds=0,this.vimeoCallbackFunctionName=this.presentz.newElementName("callback"),window[this.vimeoCallbackFunctionName]=this.receiveVideoInfo,this.elementId=this.presentz.newElementName()}var e;return t.prototype.changeVideo=function(t,n){var r;this.videoData=t,this.wouldPlay=n,r={url:"http://vimeo.com/api/v2/video/"+e(this.videoData)+".json",dataType:"jsonp",jsonpCallback:this.vimeoCallbackFunctionName},$.ajax(r)},e=function(e){return e.url.substr(e.url.lastIndexOf("/")+1)},t.prototype.receiveVideoInfo=function(t){var n,r,i,s,o=this;r="http://player.vimeo.com/video/"+e(this.videoData)+"?api=1&player_id="+this.elementId,$(this.videoContainer).children().length===0?(s='<iframe id="'+this.elementId+'" src="'+r+'" width="'+this.width+'" height="'+this.height+'" frameborder="0"></iframe>',$(this.videoContainer).append(s),n=$("#"+this.elementId)[0],i=function(e){o.onReady(e)},$f(n).addEvent("ready",i)):(n=$("#"+this.elementId)[0],n.src=r)},t.prototype.handle=function(e){return e.chapters[0].video.url.toLowerCase().indexOf("http://vimeo.com")!==-1},t.prototype.onReady=function(e){var t=this;this.player=$f(e),this.player.addEvent("play",function(){t.video.handleEvent("play")}),this.player.addEvent("pause",function(){t.video.handleEvent("pause")}),this.player.addEvent("finish",function(){t.video.handleEvent("finish")}),this.player.addEvent("playProgress",function(e){t.currentTimeInSeconds=e.seconds}),this.player.addEvent("loadProgress",function(e){t.loadedTimeInSeconds=parseInt(parseFloat(e.duration)*parseFloat(e.percent))}),this.wouldPlay&&(this.wouldPlay=!1,this.presentz.intervalSet||this.presentz.startTimeChecker(),this.player.api("play"))},t.prototype.currentTime=function(){return this.currentTimeInSeconds},t.prototype.skipTo=function(e,t){return t==null&&(t=!1),e<=this.loadedTimeInSeconds&&(this.player.api("seekTo",e),t&&this.player.api("play"),!0),!1},t.prototype.play=function(){return this.player.api("play")},t.prototype.pause=function(){return this.player.api("pause")},t.prototype.isPaused=function(){return this.video.isPaused()},t}(),f=function(){function t(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.handleEvent=l(this.handleEvent,this),this.onReady=l(this.onReady,this),this.video=new u(1,2,0,this.presentz),this.elementId=this.presentz.newElementName()}var e;return t.prototype.changeVideo=function(t,n){this.wouldPlay=n,$(this.videoContainer).children().length===0?($(this.videoContainer).append('<div id="'+this.elementId+'"></div>'),this.player=new YT.Player(this.elementId,{height:this.height,width:this.width,videoId:e(t),playerVars:{rel:0,wmode:"opaque"},events:{onReady:this.onReady,onStateChange:this.handleEvent}})):this.player.cueVideoById(e(t))},e=function(e){return e.url.substr(e.url.lastIndexOf("/")+1)},t.prototype.onReady=function(){this.presentz.intervalSet||this.presentz.startTimeChecker();if(this.wouldPlay)return this.player.playVideo()},t.prototype.handleEvent=function(e){this.video.handleEvent(e.data)},t.prototype.handle=function(e){return e.chapters[0].video.url.toLowerCase().indexOf("http://youtu.be")!==-1},t.prototype.currentTime=function(){return this.player.getCurrentTime!=null?this.player.getCurrentTime():0},t.prototype.skipTo=function(e,t){return t==null&&(t=!1),e>0&&this.player&&this.player.seekTo&&(this.player.seekTo(e,!0),t&&this.player.playVideo(),!0),!1},t.prototype.play=function(){return this.player.playVideo()},t.prototype.pause=function(){return this.player.pauseVideo()},t.prototype.isPaused=function(){return this.video.isPaused()},t}(),e=function(){function e(e,n,r,i){this.presentz=e,this.video=new t(this.presentz,n,r,i)}return e.prototype.changeVideo=function(e,t){var n;this.wouldPlay=t,n={url:e.url,dataType:"jsonp",data:"skin=json",jsonpCallback:"presentz.videoPlugin.receiveVideoInfo"},$.ajax(n)},e.prototype.receiveVideoInfo=function(e){var t;t={url:e[0].Post.media.url},this.video.changeVideo(t,this.wouldPlay),this.player=this.video.player,this.skipTo=this.video.skipTo},e.prototype.handle=function(e){return e.chapters[0].video.url.toLowerCase().indexOf("http://blip.tv")!==-1},e.prototype.currentTime=function(){return this.video.currentTime()},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),this.video.skipTo(e,t)},e.prototype.play=function(){return this.video.play()},e.prototype.pause=function(){return this.video.pause()},e}(),n=function(){function e(e,t){this.presentz=e,this.slideContainer=t,this.preloadedSlides=[]}return e.prototype.changeSlide=function(e){var t;$(""+this.slideContainer+" img").length===0?(t=$(this.slideContainer),t.empty(),t.append('<table height="100%"><tr><td valign="middle"><img width="100%" height="100%" src="'+e.url+'"></td></tr></table>')):$(""+this.slideContainer+" img")[0].setAttribute("src",e.url)},e.prototype.preload=function(e){var t,n,r,i,s,o;n=[];for(i=0,s=e.length;i<s;i++){r=e[i];if(o=r.url,c.call(this.preloadedSlides,o)>=0)continue;t=new Image,t.src=r.url,n.push(t),this.preloadedSlides.push(r.url)}return n},e}(),i=function(){function t(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.currentSlide=0,this.elementId=this.presentz.newElementName(),this.swfId=this.presentz.newElementName()}var e;return t.prototype.handle=function(e){return e.url.toLowerCase().indexOf("slideshare.net")!==-1},t.prototype.changeSlide=function(t){var n,r,i,s,o,u,a;$(this.slideContainer).children().length===0?($(this.slideContainer).append('<div id="'+this.elementId+'"></div>'),i=t.url.substr(t.url.lastIndexOf("/")+1,t.url.lastIndexOf("#")-1-t.url.lastIndexOf("/")),u={allowScriptAccess:"always",wmode:"opaque"},n={id:this.swfId},s={doc:i,rel:0},swfobject.embedSWF("http://static.slidesharecdn.com/swf/ssplayer2.swf",this.elementId,this.width,this.height,"8",null,s,u,n),this.currentSlide=0):(a=$("#"+this.swfId)[0],o=e(t),a.getCurrentSlide&&(r=a.getCurrentSlide(),o===r+1?a.next():(a.jumpTo(e(t)),this.currentSlide=a.getCurrentSlide())))},e=function(e){return parseInt(e.url.substr(e.url.lastIndexOf("#")+1))},t.prototype.preload=function(){},t}(),o=function(){function e(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.preloadedSlides=[],this.elementId=this.presentz.newElementName(),this.swfId=this.presentz.newElementName(),this.preloadSlideContainerId=this.presentz.newElementName(),this.preloadSlideId=this.presentz.newElementName()}return e.prototype.handle=function(e){return e.url.toLowerCase().indexOf(".swf")!==-1},e.prototype.changeSlide=function(e){var t,n,r;$(""+this.slideContainer+" object").length===0?($(this.slideContainer).empty(),$(this.slideContainer).append('<div id="'+this.elementId+'"></div>'),n={wmode:"opaque"},t={id:this.swfId},swfobject.embedSWF(e.url,this.elementId,this.width,this.height,"8",null,null,n,t)):(r=$("#"+this.swfId)[0],r.data=e.url)},e.prototype.preload=function(e){var t,n,r,i,s,o,u=this;n=0;for(i=0,s=e.length;i<s;i++){r=e[i];if(o=r.url,c.call(this.preloadedSlides,o)>=0)continue;$("#"+this.preloadSlideId+n).remove(),$(this.slideContainer).append('<div id="'+this.preloadSlideContainerId+n+'"></div>'),t={id:""+this.preloadSlideId+n,style:"visibility: hidden; position: absolute; margin: 0 0 0 0; top: 0;"},swfobject.embedSWF(r.url,""+this.preloadSlideContainerId+n,"1","1","8",null,null,null,t,function(){return u.preloadedSlides.push(r.url)})}},e}(),s=function(){function t(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.currentSlide=0}var e;return t.prototype.handle=function(e){return e.url.toLowerCase().indexOf("speakerdeck.com")!==-1},t.prototype.changeSlide=function(t){var n,r,i,s,o=this;$(this.slideContainer).children().length===0?(s=t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf("#")),r=function(e){if(e.origin.indexOf("speakerdeck.com")===-1)return;o.speakerdeckOrigin=e.origin,o.speakerdeck=e.source,$(""+o.slideContainer+" iframe").attr("style","");if(e.data[0]==="change")return o.currentSlide=e.data[1].number},window.addEventListener("message",r,!1),i=document.createElement("script"),i.type="text/javascript",i.async=!0,i.src="http://speakerdeck.com/assets/embed.js",i.setAttribute("class","speakerdeck-embed"),i.setAttribute("data-id",s),$(this.slideContainer)[0].appendChild(i)):this.speakerdeck!=null&&(n=e(t),this.speakerdeck.postMessage(JSON.stringify(["goToSlide",n]),this.speakerdeckOrigin))},e=function(e){return parseInt(e.url.substr(e.url.lastIndexOf("#")+1))},t.prototype.preload=function(){},t}(),r=function(){function r(r,u,l,c){var h,p;p=u.split("x"),h=c.split("x"),this.videoPlugins=[new a(this,r,p[0],p[1]),new f(this,r,p[0],p[1]),new e(this,r,p[0],p[1])],this.slidePlugins=[new i(this,l,h[0],h[1]),new o(this,l,h[0],h[1]),new s(this,l,h[0],h[1])],this.defaultVideoPlugin=new t(this,r,p[0],p[1]),this.defaultSlidePlugin=new n(this,l,h[0],h[1]),this.currentChapterIndex=-1,this.currentSlideIndex=-1,this.listeners={slidechange:[],videochange:[]}}return r.prototype.registerVideoPlugin=function(e){this.videoPlugins.push(e)},r.prototype.registerSlidePlugin=function(e){this.slidePlugins.push(e)},r.prototype.init=function(e){this.presentation=e,this.currentChapterIndex=-1,this.currentSlideIndex=-1,this.howManyChapters=this.presentation.chapters.length,this.videoPlugin=this.findVideoPlugin()},r.prototype.on=function(e,t){return this.listeners[e].push(t)},r.prototype.changeChapter=function(e,t,n){var r,i,s,o,u,a;i=this.presentation.chapters[e],s=i.slides[t];if(e!==this.currentChapterIndex||this.videoPlugin.skipTo(s.time,n)){this.changeSlide(s,e,t);if(e!==this.currentChapterIndex){this.videoPlugin.changeVideo(i.video,n),this.videoPlugin.skipTo(s.time,n),a=this.listeners.videochange;for(o=0,u=a.length;o<u;o++)r=a[o],r(this.currentChapterIndex,this.currentSlideIndex,e,t)}this.currentChapterIndex=e}},r.prototype.checkSlideChange=function(e){var t,n,r,i,s;r=this.presentation.chapters[this.currentChapterIndex].slides;for(i=0,s=r.length;i<s;i++)n=r[i],n.time<=e&&(t=n);t!=null&&this.currentSlide.url!==t.url&&this.changeSlide(t,this.currentChapterIndex,r.indexOf(t))},r.prototype.changeSlide=function(e,t,n){var r,i,s,o,u,a;this.currentSlide=e,this.slidePlugin=this.findSlidePlugin(e),this.slidePlugin.changeSlide(e),i=this.currentSlideIndex,this.currentSlideIndex=n,s=this.presentation.chapters[t].slides,s=s.slice(n+1,n+5+1||9e9),this.findSlidePlugin(e).preload(s),a=this.listeners.slidechange;for(o=0,u=a.length;o<u;o++)r=a[o],r(this.currentChapterIndex,i,t,n)},r.prototype.findVideoPlugin=function(){var e,t;return t=function(){var t,n,r,i;r=this.videoPlugins,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.handle(this.presentation)&&i.push(e);return i}.call(this),t.length>0?t[0]:this.defaultVideoPlugin},r.prototype.findSlidePlugin=function(e){var t,n;return n=function(){var n,r,i,s;i=this.slidePlugins,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.handle(e)&&s.push(t);return s}.call(this),n.length>0?n[0]:this.defaultSlidePlugin},r.prototype.startTimeChecker=function(){var e,t=this;clearInterval(this.interval),this.intervalSet=!0,e=function(){t.checkState()},this.interval=setInterval(e,500)},r.prototype.stopTimeChecker=function(){clearInterval(this.interval),this.intervalSet=!1},r.prototype.checkState=function(){this.checkSlideChange(this.videoPlugin.currentTime())},r.prototype.newElementName=function(e){return e!=null?""+e+"_"+Math.round(Math.random()*1e6):"element_"+Math.round(Math.random()*1e6)},r.prototype.pause=function(){return this.videoPlugin.pause()},r.prototype.isPaused=function(){return this.videoPlugin.isPaused()},r.prototype.play=function(){return this.videoPlugin.play()},r.prototype.next=function(){return this.presentation.chapters[this.currentChapterIndex].slides.length>this.currentSlideIndex+1?(this.changeChapter(this.currentChapterIndex,this.currentSlideIndex+1),!0):this.presentation.chapters.length>this.currentChapterIndex+1?(this.changeChapter(this.currentChapterIndex+1,0),!0):!1},r.prototype.previous=function(){return this.currentSlideIndex-1>=0?(this.changeChapter(this.currentChapterIndex,this.currentSlideIndex-1),!0):this.currentChapterIndex-1>=0?(this.changeChapter(this.currentChapterIndex-1,this.presentation.chapters[this.currentChapterIndex-1].slides.length-1),!0):!1},r}(),window.Presentz=r}).call(this);