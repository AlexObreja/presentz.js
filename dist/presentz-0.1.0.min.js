/*
Presentz - A web library to show synchronized video + slides presentations

Copyright (C) 2012 Federico Fissore

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/// Generated by CoffeeScript 1.3.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},h=function(e,t){return function(){return e.apply(t,arguments)}};u=function(){function e(e,t,n,r){this.playStates=e,this.pauseStates=t,this.finishStates=n,this.presentz=r,this.isInPauseState=!0}return e.prototype.handleEvent=function(e){var t,n,r,i;this.isInPlayState=c.call(this.playStates,e)>=0,this.isInPauseState=c.call(this.pauseStates,e)>=0,this.isInFinishState=c.call(this.finishStates,e)>=0;if(this.isInPlayState)this.presentz.startTimeChecker(),n=this.presentz.listeners.play;else if(this.isInPauseState||this.isInFinishState)this.presentz.stopTimeChecker(),this.isInPauseState?n=this.presentz.listeners.pause:this.isInFinishState&&(n=this.presentz.listeners.finish);if(n!=null)for(r=0,i=n.length;r<i;r++)t=n[r],t();this.isInFinishState&&this.presentz.currentChapterIndex<this.presentz.howManyChapters-1&&this.presentz.changeChapter(this.presentz.currentChapterIndex+1,0,!0)},e}(),t=function(){function e(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.video=new u(["play"],["pause"],["ended"],this.presentz),this.elementId=this.presentz.newElementName()}return e.prototype.handle=function(e){return!0},e.prototype.changeVideo=function(e,t){var n,r,i=this;this.wouldPlay=t,jQuery(this.videoContainer).empty(),r='<video id="'+this.elementId+'" controls preload="none" src="'+e.url+'" width="100%" height="100%"></video>',jQuery(this.videoContainer).append(r),n={timerRate:500,success:function(e){i.onPlayerLoaded(e)}},new MediaElementPlayer("#"+this.elementId,n)},e.prototype.onPlayerLoaded=function(e){var t,n=this;this.player=e,t=function(e){n.video.handleEvent(e.type)},e.addEventListener("play",t,!1),e.addEventListener("pause",t,!1),e.addEventListener("ended",t,!1),this.player.load(),this.wouldPlay&&this.play()},e.prototype.currentTime=function(){return this.player.currentTime},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),this.player&&this.player.currentTime&&(this.player.setCurrentTime(e),t&&this.play(),!0),!1},e.prototype.play=function(){return this.player.play()},e.prototype.pause=function(){return this.player.pause()},e.prototype.isPaused=function(){return this.video.isInPauseState},e}(),a=function(){function e(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.receiveVideoInfo=h(this.receiveVideoInfo,this),this.video=new u(["play"],["pause"],["finish"],this.presentz),this.wouldPlay=!1,this.currentTimeInSeconds=0,this.vimeoCallbackFunctionName=this.presentz.newElementName("callback"),typeof window!="undefined"&&window!==null&&(window[this.vimeoCallbackFunctionName]=this.receiveVideoInfo),this.elementId=this.presentz.newElementName()}return e.prototype.changeVideo=function(e,t){var n;this.videoData=e,this.wouldPlay=t,n={url:"http://vimeo.com/api/v2/video/"+this.videoId(this.videoData)+".json",dataType:"jsonp",jsonpCallback:this.vimeoCallbackFunctionName},jQuery.ajax(n)},e.prototype.videoId=function(e){var t;return t=e.url,t=t.substr(t.lastIndexOf("/")+1),t.indexOf("?")!==-1&&(t=t.substr(0,t.indexOf("?"))),t},e.prototype.receiveVideoInfo=function(e){var t,n,r,i,s=this;n="http://player.vimeo.com/video/"+this.videoId(this.videoData)+"?api=1&player_id="+this.elementId,jQuery("#"+this.elementId).length===0?(i='<iframe id="'+this.elementId+'" src="'+n+'" width="'+this.width+'" height="'+this.height+'" frameborder="0"></iframe>',jQuery(this.videoContainer).append(i),t=jQuery("#"+this.elementId)[0],r=function(e){s.onReady(e)},$f(t).addEvent("ready",r)):(t=jQuery("#"+this.elementId)[0],t.src=n)},e.prototype.handle=function(e){return e.url.toLowerCase().indexOf("//vimeo.com/")!==-1},e.prototype.onReady=function(e){var t=this;this.player=$f(e),this.player.addEvent("play",function(){t.video.handleEvent("play")}),this.player.addEvent("pause",function(){t.video.handleEvent("pause")}),this.player.addEvent("finish",function(){t.video.handleEvent("finish")}),this.player.addEvent("playProgress",function(e){t.currentTimeInSeconds=e.seconds}),this.player.addEvent("loadProgress",function(e){t.loadedTimeInSeconds=parseInt(parseFloat(e.duration)*parseFloat(e.percent))}),this.wouldPlay&&(this.wouldPlay=!1,this.play())},e.prototype.currentTime=function(){return this.currentTimeInSeconds},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),e<=this.loadedTimeInSeconds&&(this.player.api("seekTo",e),t&&this.play(),!0),!1},e.prototype.play=function(){return this.player.api("play")},e.prototype.pause=function(){return this.player.api("pause")},e.prototype.isPaused=function(){return this.video.isPaused()},e}(),l=typeof exports!="undefined"&&exports!==null?exports:window,l.presentz==null&&(l.presentz={}),l.presentz.Vimeo=a,f=function(){function e(e,t,n,r){this.presentz=e,this.videoContainer=t,this.width=n,this.height=r,this.handleEvent=h(this.handleEvent,this),this.onReady=h(this.onReady,this),this.video=new u([1],[-1,2],[0],this.presentz),this.elementId=this.presentz.newElementName()}return e.prototype.changeVideo=function(e,t){this.wouldPlay=t,jQuery("#"+this.elementId).length===0?(jQuery(this.videoContainer).append('<div id="'+this.elementId+'"></div>'),this.player=new YT.Player(this.elementId,{height:this.height,width:this.width,videoId:this.videoId(e),playerVars:{rel:0,wmode:"opaque"},events:{onReady:this.onReady,onStateChange:this.handleEvent}})):this.player.cueVideoById(this.videoId(e))},e.prototype.videoId=function(e){var t,n;n=e.url.toLowerCase(),t=e.url;if(n.indexOf("//youtu.be/")!==-1)t=t.substr(t.lastIndexOf("/")+1),t.indexOf("?")!==-1&&(t=t.substr(0,t.indexOf("?")));else if(n.indexOf("//youtube.com/")!==-1||n.indexOf("//www.youtube.com/")!==-1)t=t.substr(t.indexOf("v=")+2),t.indexOf("&")!==-1&&(t=t.substr(0,t.indexOf("&")));return t},e.prototype.onReady=function(){if(this.wouldPlay)return this.play()},e.prototype.handleEvent=function(e){this.video.handleEvent(e.data)},e.prototype.handle=function(e){var t;return t=e.url.toLowerCase(),t.indexOf("//youtu.be/")!==-1||t.indexOf("//youtube.com/")!==-1||t.indexOf("//www.youtube.com/")!==-1},e.prototype.currentTime=function(){return this.player.getCurrentTime!=null?this.player.getCurrentTime():0},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),this.player&&this.player.seekTo&&((t||this.isPaused())&&this.player.seekTo(e,!0),t&&this.play(),!0),!1},e.prototype.play=function(){return this.player.playVideo()},e.prototype.pause=function(){return this.player.pauseVideo()},e.prototype.isPaused=function(){return this.video.isInPauseState},e}(),l=typeof exports!="undefined"&&exports!==null?exports:window,l.presentz==null&&(l.presentz={}),l.presentz.Youtube=f,e=function(){function e(e,n,r,i){this.presentz=e,this.video=new t(this.presentz,n,r,i)}return e.prototype.changeVideo=function(e,t){var n;this.wouldPlay=t,n={url:e.url,dataType:"jsonp",data:"skin=json",jsonpCallback:"presentz.videoPlugin.receiveVideoInfo"},jQuery.ajax(n)},e.prototype.receiveVideoInfo=function(e){var t;t={url:e[0].Post.media.url},this.video.changeVideo(t,this.wouldPlay),this.player=this.video.player,this.skipTo=this.video.skipTo},e.prototype.handle=function(e){return e.url.toLowerCase().indexOf("http://blip.tv")!==-1},e.prototype.currentTime=function(){return this.video.currentTime()},e.prototype.skipTo=function(e,t){return t==null&&(t=!1),this.video.skipTo(e,t)},e.prototype.play=function(){return this.video.play()},e.prototype.pause=function(){return this.video.pause()},e}(),n=function(){function e(e,t){this.presentz=e,this.slideContainer=t,this.preloadedSlides=[]}return e.prototype.handle=function(e){return!0},e.prototype.changeSlide=function(e){var t;jQuery(""+this.slideContainer+" img").length===0?(t=jQuery(this.slideContainer),t.empty(),t.append('<img src="'+e.url+'"/>')):jQuery(""+this.slideContainer+" img").attr("src",e.url)},e.prototype.preload=function(e){var t,n;if(n=e.url,c.call(this.preloadedSlides,n)>=0)return;t=new Image,t.src=e.url},e}(),i=function(){function e(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.currentSlide=0,this.elementId=this.presentz.newElementName(),this.swfId=this.presentz.newElementName()}return e.prototype.handle=function(e){return e.url.toLowerCase().indexOf("slideshare.net")!==-1},e.prototype.slideId=function(e){return e.url.substr(e.url.lastIndexOf("/")+1,e.url.lastIndexOf("#")-1-e.url.lastIndexOf("/"))},e.prototype.slideNumber=function(e){return parseInt(e.url.substr(e.url.lastIndexOf("#")+1))},e.prototype.changeSlide=function(e){var t,n,r,i,s,o,u;jQuery("#"+this.swfId).length===0?(jQuery(this.slideContainer).append('<div id="'+this.elementId+'"></div>'),r=this.slideId(e),o={allowScriptAccess:"always",wmode:"opaque"},t={id:this.swfId},i={doc:r,rel:0},swfobject.embedSWF("http://static.slidesharecdn.com/swf/ssplayer2.swf",this.elementId,this.width,this.height,"8",null,i,o,t),this.currentSlide=0):(u=jQuery("#"+this.swfId)[0],s=this.slideNumber(e),u.getCurrentSlide!=null&&(n=u.getCurrentSlide(),s===n+1?u.next():(u.jumpTo(this.slideNumber(e)),this.currentSlide=u.getCurrentSlide())))},e}(),l=typeof exports!="undefined"&&exports!==null?exports:window,l.presentz==null&&(l.presentz={}),l.presentz.SlideShare=i,o=function(){function e(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.preloadedSlides=[],this.elementId=this.presentz.newElementName(),this.swfId=this.presentz.newElementName(),this.preloadSlideContainerId=this.presentz.newElementName(),this.preloadSlideId=this.presentz.newElementName()}return e.prototype.handle=function(e){return e.url.toLowerCase().indexOf(".swf")!==-1},e.prototype.changeSlide=function(e){var t,n,r;jQuery("#"+this.swfId).length===0?(jQuery(this.slideContainer).empty(),jQuery(this.slideContainer).append('<div id="'+this.elementId+'"></div>'),n={wmode:"opaque"},t={id:this.swfId},swfobject.embedSWF(e.url,this.elementId,this.width,this.height,"8",null,null,n,t)):(r=jQuery("#"+this.swfId)[0],r.data=e.url)},e.prototype.preload=function(e){var t,n,r=this;if(n=e.url,c.call(this.preloadedSlides,n)>=0)return;jQuery("#"+this.preloadSlideId).remove(),jQuery(this.slideContainer).append('<div id="'+this.preloadSlideContainerId+'"></div>'),t={id:""+this.preloadSlideId,style:"visibility: hidden; position: absolute; margin: 0 0 0 0; top: 0;"},swfobject.embedSWF(e.url,""+this.preloadSlideContainerId,"1","1","8",null,null,null,t,function(){return r.preloadedSlides.push(e.url)})},e}(),l=typeof exports!="undefined"&&exports!==null?exports:window,l.presentz==null&&(l.presentz={}),l.presentz.SwfSlide=o,s=function(){function t(e,t,n,r){this.presentz=e,this.slideContainer=t,this.width=n,this.height=r,this.currentSlide=0,this.elementId=this.presentz.newElementName()}var e;return t.prototype.handle=function(e){return e.url.toLowerCase().indexOf("speakerdeck.com")!==-1},t.prototype.changeSlide=function(t){var n,r,i,s,o=this;jQuery(""+this.slideContainer+" iframe.speakerdeck-iframe").length===0?(jQuery(this.slideContainer).empty(),s=t.url.substring(t.url.lastIndexOf("/")+1,t.url.lastIndexOf("#")),r=function(e){if(e.origin.indexOf("speakerdeck.com")===-1)return;o.speakerdeckOrigin=e.origin,o.speakerdeck=e.source,jQuery(""+o.slideContainer+" iframe.speakerdeck-iframe").attr("style","");if(e.data[0]==="change")return o.currentSlide=e.data[1].number},window.addEventListener("message",r,!1),i=document.createElement("script"),i.type="text/javascript",i.async=!0,i.src="http://speakerdeck.com/assets/embed.js",i.setAttribute("class","speakerdeck-embed"),i.setAttribute("data-id",s),jQuery(this.slideContainer)[0].appendChild(i)):this.speakerdeck!=null&&(n=e(t),this.speakerdeck.postMessage(JSON.stringify(["goToSlide",n]),this.speakerdeckOrigin))},e=function(e){return parseInt(e.url.substr(e.url.lastIndexOf("#")+1))},t}(),r=function(){function r(r,u,l,c){var h,p;p=u.split("x"),h=c.split("x"),this.availableVideoPlugins={vimeo:new a(this,r,p[0],p[1]),youtube:new f(this,r,p[0],p[1]),bliptv:new e(this,r,p[0],p[1]),html5:new t(this,r,p[0],p[1])},this.availableSlidePlugins={slideshare:new i(this,l,h[0],h[1]),swf:new o(this,l,h[0],h[1]),speakerdeck:new s(this,l,h[0],h[1]),image:new n(this,l,h[0],h[1])},this.videoPlugins=[this.availableVideoPlugins.vimeo,this.availableVideoPlugins.youtube,this.availableVideoPlugins.bliptv],this.slidePlugins=[this.availableSlidePlugins.slideshare,this.availableSlidePlugins.swf,this.availableSlidePlugins.speakerdeck],this.defaultVideoPlugin=this.availableVideoPlugins.html5,this.defaultSlidePlugin=this.availableSlidePlugins.image,this.currentChapterIndex=-1,this.currentChapter=void 0,this.currentSlideIndex=-1,this.listeners={slidechange:[],videochange:[],timechange:[],play:[],pause:[],finish:[]},this.isSynchronized=!0}return r.prototype.registerVideoPlugin=function(e,t){this.availableVideoPlugins[e]=t,this.videoPlugins.push(this.availableVideoPlugins[e])},r.prototype.registerSlidePlugin=function(e,t){this.availableSlidePlugins[e]=t,this.slidePlugins.push(this.availableSlidePlugins[e])},r.prototype.init=function(e){var t,n,r,i,s,o,u,a;this.presentation=e,this.currentChapterIndex=-1,this.currentChapter=void 0,this.currentSlideIndex=-1,this.howManyChapters=this.presentation.chapters.length,u=this.presentation.chapters;for(r=0,s=u.length;r<s;r++){t=u[r],t.video._plugin=this.findVideoPlugin(t.video),a=t.slides;for(i=0,o=a.length;i<o;i++)n=a[i],n._plugin=this.findSlidePlugin(n)}},r.prototype.on=function(e,t){return this.listeners[e].push(t)},r.prototype.changeChapter=function(e,t,n){var r,i,s,o,u,a;i=this.presentation.chapters[e],s=i.slides[t];if(e!==this.currentChapterIndex||this.currentChapter!=null&&this.currentChapter.video._plugin.skipTo(s.time,n)){this.changeSlide(s,e,t);if(e!==this.currentChapterIndex){i.video._plugin.changeVideo(i.video,n),i.video._plugin.skipTo(s.time,n),a=this.listeners.videochange;for(o=0,u=a.length;o<u;o++)r=a[o],r(this.currentChapterIndex,this.currentSlideIndex,e,t)}this.currentChapterIndex=e,this.currentChapter=i}},r.prototype.checkSlideChange=function(e){var t,n,r,i,s,o,u,a,f;i=this.presentation.chapters[this.currentChapterIndex].slides;for(s=0,u=i.length;s<u;s++)r=i[s],r.time<=e&&(t=r);t!=null&&this.currentSlide.url!==t.url&&this.changeSlide(t,this.currentChapterIndex,i.indexOf(t)),f=this.listeners.timechange;for(o=0,a=f.length;o<a;o++)n=f[o],n(e)},r.prototype.changeSlide=function(e,t,n){var r,i,s,o,u,a,f,l,c;this.currentSlide=e,e._plugin.changeSlide(e),o=this.currentSlideIndex,this.currentSlideIndex=n,i=this.presentation.chapters[t].slides.slice(n+1,n+5+1||9e9);for(u=0,f=i.length;u<f;u++)s=i[u],s._plugin.preload!=null&&s._plugin.preload(s);c=this.listeners.slidechange;for(a=0,l=c.length;a<l;a++)r=c[a],r(this.currentChapterIndex,o,t,n)},r.prototype.findVideoPlugin=function(e){var t,n;return n=function(){var n,r,i,s;i=this.videoPlugins,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.handle(e)&&s.push(t);return s}.call(this),n.length>0?n[0]:this.defaultVideoPlugin},r.prototype.findSlidePlugin=function(e){var t,n;return n=function(){var n,r,i,s;i=this.slidePlugins,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.handle(e)&&s.push(t);return s}.call(this),n.length>0?n[0]:this.defaultSlidePlugin},r.prototype.synchronized=function(e){this.isSynchronized=e,this.intervalSet&&!this.isSynchronized&&this.stopTimeChecker();if(!this.intervalSet&&this.isSynchronized&&!this.isPaused())return this.startTimeChecker()},r.prototype.startTimeChecker=function(){var e,t=this;if(!this.isSynchronized)return;clearInterval(this.interval),this.intervalSet=!0,e=function(){t.checkState()},this.interval=setInterval(e,500)},r.prototype.stopTimeChecker=function(){clearInterval(this.interval),this.intervalSet=!1},r.prototype.checkState=function(){this.currentChapter!=null&&this.checkSlideChange(this.currentChapter.video._plugin.currentTime())},r.prototype.newElementName=function(e){return e!=null?""+e+"_"+Math.round(Math.random()*1e6):"element_"+Math.round(Math.random()*1e6)},r.prototype.pause=function(){if(this.currentChapter!=null)return this.currentChapter.video._plugin.pause()},r.prototype.isPaused=function(){if(this.currentChapter!=null)return this.currentChapter.video._plugin.isPaused()},r.prototype.play=function(){if(this.currentChapter!=null)return this.currentChapter.video._plugin.play()},r.prototype.next=function(){return this.presentation.chapters[this.currentChapterIndex].slides.length>this.currentSlideIndex+1?(this.changeChapter(this.currentChapterIndex,this.currentSlideIndex+1,!0),!0):this.presentation.chapters.length>this.currentChapterIndex+1?(this.changeChapter(this.currentChapterIndex+1,0,!0),!0):!1},r.prototype.previous=function(){return this.currentSlideIndex-1>=0?(this.changeChapter(this.currentChapterIndex,this.currentSlideIndex-1,!0),!0):this.currentChapterIndex-1>=0?(this.changeChapter(this.currentChapterIndex-1,this.presentation.chapters[this.currentChapterIndex-1].slides.length-1,!0),!0):!1},r}(),l=typeof exports!="undefined"&&exports!==null?exports:window,l.presentz==null&&(l.presentz={}),l.presentz.Presentz=r,l.Presentz=r}).call(this);